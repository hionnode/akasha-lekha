# .github/workflows/web-preview.yml
#
# Deploys preview versions for Pull Requests (Web only)
# Triggers only when web app or shared types change
# Provides Vercel-like experience with:
# - Automatic preview URL on every PR
# - Rich PR comments with status, URL, build time
# - Commit status checks

name: Web Preview

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - 'apps/web/**'
      - 'packages/types/**'
      - 'pnpm-lock.yaml'

concurrency:
  group: web-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  statuses: write
  deployments: write

env:
  WRANGLER_SEND_METRICS: false

jobs:
  preview:
    name: Deploy Preview
    runs-on: ubuntu-latest

    environment:
      name: preview
      url: ${{ steps.deploy.outputs.deployment-url }}

    outputs:
      url: ${{ steps.deploy.outputs.deployment-url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Pending Status
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'pending',
              context: 'Web Preview',
              description: 'Building...'
            });

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Cache Astro Build
        uses: actions/cache@v4
        id: cache-astro
        with:
          path: |
            apps/web/node_modules/.astro
            apps/web/.astro
          key: astro-preview-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'apps/web/astro.config.*') }}
          restore-keys: |
            astro-preview-${{ runner.os }}-

      - name: Install Dependencies
        run: pnpm install

      - name: Build
        id: build
        run: |
          START_TIME=$(date +%s)
          pnpm --filter @akasha/web build
          END_TIME=$(date +%s)
          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT
        env:
          PUBLIC_ENV: preview
          PUBLIC_PREVIEW_URL: https://preview-${{ github.event.pull_request.number }}.${{ vars.WORKER_NAME || 'akasha-lekha' }}.workers.dev

      - name: Deploy Preview
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/web
          command: versions upload --message "PR #${{ github.event.pull_request.number }}"

      - name: Update Commit Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            const deploymentUrl = '${{ steps.deploy.outputs.deployment-url }}';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              target_url: deploymentUrl || `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: state === 'success' ? 'Preview ready' : 'Preview failed',
              context: 'Web Preview'
            });

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        env:
          DEPLOY_URL: ${{ steps.deploy.outputs.deployment-url }}
          DEPLOY_STATUS: ${{ job.status }}
          BUILD_DURATION: ${{ steps.build.outputs.duration }}
          CACHE_HIT: ${{ steps.cache-astro.outputs.cache-hit }}
        with:
          script: |
            const status = process.env.DEPLOY_STATUS;
            const url = process.env.DEPLOY_URL;
            const buildDuration = process.env.BUILD_DURATION || '?';
            const cacheHit = process.env.CACHE_HIT === 'true';
            const sha = context.sha.substring(0, 7);
            const fullSha = context.sha;
            const prNumber = context.issue.number;
            const branch = context.payload.pull_request.head.ref;
            const timestamp = new Date().toISOString();
            const prettyTime = new Date().toLocaleString('en-US', {
              timeZone: 'UTC',
              dateStyle: 'medium',
              timeStyle: 'short'
            }) + ' UTC';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const statusConfig = {
              success: { emoji: '‚úÖ', text: 'Ready' },
              failure: { emoji: '‚ùå', text: 'Failed' },
              cancelled: { emoji: '‚èπÔ∏è', text: 'Cancelled' }
            };
            const { emoji, text } = statusConfig[status] || statusConfig.failure;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('<!-- web-preview-bot -->')
            );

            let history = [];
            if (botComment) {
              const historyMatch = botComment.body.match(/<!-- history:(.+?) -->/s);
              if (historyMatch) {
                try {
                  history = JSON.parse(Buffer.from(historyMatch[1], 'base64').toString());
                } catch (e) {
                  history = [];
                }
              }
            }

            history.unshift({
              sha, fullSha, status, url,
              time: timestamp,
              duration: buildDuration,
              cached: cacheHit
            });
            history = history.slice(0, 5);

            let body = `<!-- web-preview-bot -->\n`;
            body += `<!-- history:${Buffer.from(JSON.stringify(history)).toString('base64')} -->\n`;
            body += `## üåê Web Preview Deployment\n\n`;

            if (status === 'success' && url) {
              body += `### üîó [**Visit Preview ‚Üí**](${url})\n\n`;
              body += `| Branch | Commit | Build | Cache | Status |\n`;
              body += `|:-------|:-------|:------|:------|:-------|\n`;
              body += `| \`${branch}\` | [\`${sha}\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${fullSha}) | ${buildDuration}s | ${cacheHit ? '‚úÖ' : '‚ùå'} | ${emoji} ${text} |\n\n`;
            } else {
              body += `### ${emoji} Deployment ${text}\n\n`;
              body += `| Branch | Commit | Status |\n`;
              body += `|:-------|:-------|:-------|\n`;
              body += `| \`${branch}\` | [\`${sha}\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${fullSha}) | ${emoji} ${text} |\n\n`;
              body += `> ‚ö†Ô∏è **Build failed** ‚Äî [View logs](${runUrl})\n\n`;
            }

            if (history.length > 1) {
              body += `<details>\n<summary>üìú History (${history.length})</summary>\n\n`;
              body += `| Commit | Status | Build | Cache | Time |\n`;
              body += `|:-------|:-------|:------|:------|:-----|\n`;
              for (const h of history) {
                const hEmoji = h.status === 'success' ? '‚úÖ' : (h.status === 'failure' ? '‚ùå' : '‚èπÔ∏è');
                const link = h.url ? `[\`${h.sha}\`](${h.url})` : `\`${h.sha}\``;
                const time = new Date(h.time).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                body += `| ${link} | ${hEmoji} | ${h.duration}s | ${h.cached ? '‚úÖ' : '‚ùå'} | ${time} |\n`;
              }
              body += `\n</details>\n`;
            }

            body += `\n---\n<sub>üöÄ Cloudflare Pages ¬∑ ${prettyTime} ¬∑ [Logs](${runUrl})</sub>`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            }

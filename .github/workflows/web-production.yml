# .github/workflows/web-production.yml
#
# Deploys web app to production when merged to main
# Triggers only when web app or shared types change

name: Web Production

on:
  push:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/types/**'
      - 'pnpm-lock.yaml'
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'Skip build cache'
        type: boolean
        default: false

concurrency:
  group: web-production
  cancel-in-progress: false

permissions:
  contents: read
  deployments: write
  statuses: write

env:
  WRANGLER_SEND_METRICS: false

jobs:
  deploy:
    name: Deploy Production
    runs-on: ubuntu-latest

    environment:
      name: production
      url: ${{ steps.deploy.outputs.deployment-url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Cache Astro Build
        if: ${{ !inputs.skip_cache }}
        uses: actions/cache@v4
        id: cache-astro
        with:
          path: |
            apps/web/node_modules/.astro
            apps/web/.astro
          key: astro-prod-${{ runner.os }}-${{ hashFiles('apps/web/src/**/*', 'apps/web/public/**/*', 'apps/web/astro.config.*') }}
          restore-keys: |
            astro-prod-${{ runner.os }}-

      - name: Install Dependencies
        run: pnpm install

      - name: Build
        id: build
        run: |
          START_TIME=$(date +%s)
          pnpm --filter @akasha/web build
          END_TIME=$(date +%s)
          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT
        env:
          PUBLIC_ENV: production

      - name: Get Previous Version
        id: previous
        run: |
          cd apps/web
          PREV_VERSION=$(npx wrangler versions list --json 2>/dev/null | jq -r '.[0].id // empty' || echo "")
          echo "version=$PREV_VERSION" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Production
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/web
          command: deploy

      - name: Create Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Web Production Deployment Complete

          | Property | Value |
          |:---------|:------|
          | **URL** | ${{ steps.deploy.outputs.deployment-url }} |
          | **Commit** | `${{ github.sha }}` |
          | **Build Time** | ${{ steps.build.outputs.duration }}s |
          | **Cache** | ${{ steps.cache-astro.outputs.cache-hit == 'true' && 'âœ… Hit' || 'âŒ Miss' }} |
          | **Triggered by** | @${{ github.actor }} |
          | **Previous Version** | `${{ steps.previous.outputs.version || 'N/A' }}` |

          ### Rollback Command
          ```bash
          cd apps/web && npx wrangler versions deploy ${{ steps.previous.outputs.version }}
          ```
          EOF

      - name: Update Commit Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            const url = '${{ steps.deploy.outputs.deployment-url }}';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              target_url: url || `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: state === 'success' ? 'Deployed to production' : 'Production deploy failed',
              context: 'Web Production'
            });

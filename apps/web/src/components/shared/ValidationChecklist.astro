---
interface Props {
  items: { category: string; tasks: (string | { text: string; syncKey?: string })[] }[];
}

const { items } = Astro.props;
const checklistId = 'validation-checklist';
---

<div class="validation-checklist">
  <div class="checklist-container">
    {
      items.map((section, sectionIdx) => (
        <div class="checklist-section">
          <h4 class="section-title">{section.category}</h4>
          <ul class="task-list">
            {section.tasks.map((task, taskIdx) => {
              const taskId = `${checklistId}-${sectionIdx}-${taskIdx}`;
              const taskText = typeof task === 'string' ? task : task.text;
              const syncKey = typeof task === 'object' && task.syncKey ? task.syncKey : undefined;
              return (
                <li class="task-item">
                  <label class="task-label">
                    <input
                      type="checkbox"
                      class="task-checkbox"
                      data-task-id={taskId}
                      data-sync-key={syncKey}
                    />
                    <span class="task-text">{taskText}</span>
                  </label>
                </li>
              );
            })}
          </ul>
        </div>
      ))
    }
  </div>

  <div class="checklist-progress">
    <div class="progress-bar">
      <div class="progress-fill" id="checklist-progress-fill"></div>
    </div>
    <p class="progress-text" id="checklist-progress-text">0 of 0 completed</p>
  </div>
</div>

<script>
  function initValidationChecklist() {
    const checkboxes = document.querySelectorAll('.task-checkbox');
    const progressFill = document.getElementById('checklist-progress-fill');
    const progressText = document.getElementById('checklist-progress-text');

    if (!progressFill || !progressText) return;

    // Load saved state from localStorage
    checkboxes.forEach((checkbox) => {
      const taskId = checkbox.getAttribute('data-task-id');
      const syncKey = checkbox.getAttribute('data-sync-key');
      if (!taskId) return;

      const saved = localStorage.getItem(taskId);
      if (saved === 'true') {
        (checkbox as HTMLInputElement).checked = true;
      }

      // Listen for sync events from GuideSteps
      if (syncKey) {
        window.addEventListener('storage', (e) => {
          if (e.key === `sync-${syncKey}` && e.newValue) {
            const syncState = JSON.parse(e.newValue);
            if (syncState.source !== 'checklist') {
              (checkbox as HTMLInputElement).checked = syncState.completed;
              localStorage.setItem(taskId, syncState.completed.toString());
              updateProgress();
            }
          }
        });

        // Check for existing sync state
        const syncState = localStorage.getItem(`sync-${syncKey}`);
        if (syncState) {
          const state = JSON.parse(syncState);
          (checkbox as HTMLInputElement).checked = state.completed;
          localStorage.setItem(taskId, state.completed.toString());
        }
      }

      // Save state on change
      checkbox.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        localStorage.setItem(taskId, target.checked.toString());
        updateProgress();

        // Sync with GuideStep if syncKey exists
        if (syncKey) {
          localStorage.setItem(
            `sync-${syncKey}`,
            JSON.stringify({
              completed: target.checked,
              source: 'checklist',
            })
          );

          // Trigger storage event for same-page sync
          window.dispatchEvent(
            new StorageEvent('storage', {
              key: `sync-${syncKey}`,
              newValue: JSON.stringify({ completed: target.checked, source: 'checklist' }),
            })
          );
        }
      });
    });

    // Update progress display
    function updateProgress() {
      const total = checkboxes.length;
      const completed = Array.from(checkboxes).filter(
        (cb) => (cb as HTMLInputElement).checked
      ).length;

      const percentage = total > 0 ? (completed / total) * 100 : 0;

      if (progressFill) {
        progressFill.style.width = `${percentage}%`;
      }

      if (progressText) {
        progressText.textContent = `${completed} of ${total} completed`;
      }
    }

    // Initial progress update
    updateProgress();
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initValidationChecklist);
  } else {
    initValidationChecklist();
  }

  // Re-initialize on navigation (Astro View Transitions)
  document.addEventListener('astro:page-load', initValidationChecklist);
</script>

<style>
  .validation-checklist {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
  }

  .checklist-container {
    display: grid;
    gap: 1.5rem;
  }

  .checklist-section {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .section-title {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--accent-blue);
  }

  .task-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .task-item {
    display: flex;
    align-items: flex-start;
  }

  .task-label {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.25rem;
    transition: background-color 0.2s ease;
    width: 100%;
  }

  .task-label:hover {
    background: rgba(var(--accent-blue-rgb, 59, 130, 246), 0.05);
  }

  .task-checkbox {
    margin-top: 0.125rem;
    width: 1.125rem;
    height: 1.125rem;
    cursor: pointer;
    accent-color: var(--accent-blue);
    flex-shrink: 0;
  }

  .task-text {
    color: var(--fg-secondary);
    line-height: 1.5;
    font-size: 0.9375rem;
  }

  .task-checkbox:checked + .task-text {
    color: var(--fg-muted);
    text-decoration: line-through;
  }

  .checklist-progress {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  .progress-bar {
    height: 0.5rem;
    background: var(--bg-tertiary);
    border-radius: 0.25rem;
    overflow: hidden;
    margin-bottom: 0.75rem;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(to right, var(--accent-blue), var(--accent-cyan));
    width: 0%;
    transition: width 0.3s ease;
  }

  .progress-text {
    margin: 0;
    text-align: center;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--fg-muted);
  }

  @media (max-width: 640px) {
    .validation-checklist {
      padding: 1rem;
    }

    .task-text {
      font-size: 0.875rem;
    }

    .task-checkbox {
      width: 1rem;
      height: 1rem;
    }
  }
</style>

---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/layout/Header.astro';
import Footer from '../../../components/layout/Footer.astro';
import Container from '../../../components/layout/Container.astro';
import SEO from '../../../components/shared/SEO.astro';
import GuideNav from '../../../components/guides/GuideNav.astro';
import PartNav from '../../../components/guides/PartNav.astro';
import { calculateReadingTime } from '../../../utils/readingTime';

export async function getStaticPaths() {
  const guides = await getCollection('guides');
  const parts = guides.filter((guide) => 'part' in guide.data);

  return parts.map((part) => {
    const slugParts = part.slug.split('/');
    const guideSlug = slugParts[0];
    const partSlug = slugParts[1];

    // Get guide index and all parts
    const guideIndex = guides.find(
      (g) => g.slug === guideSlug && 'parts' in g.data
    );
    const allParts = guides
      .filter((g) => g.slug.startsWith(guideSlug) && 'part' in g.data)
      .sort((a, b) => (a.data as { part: number }).part - (b.data as { part: number }).part);

    const currentIndex = allParts.findIndex((p) => p.slug === part.slug);
    const previousPart = currentIndex > 0 ? {
      slug: allParts[currentIndex - 1].slug.split('/').pop()!,
      title: (allParts[currentIndex - 1].data as { title: string }).title,
    } : undefined;
    const nextPart = currentIndex < allParts.length - 1 ? {
      slug: allParts[currentIndex + 1].slug.split('/').pop()!,
      title: (allParts[currentIndex + 1].data as { title: string }).title,
    } : undefined;

    return {
      params: { guideSlug: guideSlug, partSlug: partSlug },
      props: { part, guideIndex, allParts, previousPart, nextPart },
    };
  });
}

interface Props {
  part: Awaited<ReturnType<typeof getCollection<'guides'>>>[number];
  guideIndex?: Awaited<ReturnType<typeof getCollection<'guides'>>>[number];
  allParts: Awaited<ReturnType<typeof getCollection<'guides'>>>[number][];
  previousPart?: { slug: string; title: string };
  nextPart?: { slug: string; title: string };
}

const { part, guideIndex, allParts, previousPart, nextPart } = Astro.props;
const { Content } = await part.render();
const partData = part.data as { title: string; date: string; guide: string };
const guideTitle = guideIndex ? (guideIndex.data as { title: string }).title : partData.guide;
const guideSlug = part.slug.split('/')[0];
const readingTime = calculateReadingTime(part.body);
const formattedDate = new Date(partData.date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const navParts = allParts.map((p) => ({
  slug: p.slug.split('/').pop()!,
  title: (p.data as { title: string }).title,
}));
---

<Layout title={`${partData.title} | ${guideTitle} | works-on-my.cloud`}>
  <SEO
    title={partData.title}
    description={`Part of ${guideTitle}`}
    type="article"
    publishedTime={partData.date}
    tags={(part.data as { tags: string[] }).tags}
  />
  <div class="min-h-screen flex flex-col">
    <Header />
    <!-- Reading Progress Bar -->
    <div id="reading-progress" class="fixed top-0 left-0 right-0 h-1 bg-bg-tertiary z-40">
      <div id="reading-progress-bar" class="h-full bg-gradient-to-r from-accent-blue via-accent-cyan to-accent-blue transition-all duration-150" style="width: 0%"></div>
    </div>
    <main id="main-content" class="flex-1">
      <Container class="py-12">
        <div class="max-w-4xl mx-auto">
          <nav class="mb-6 text-sm text-fg-muted">
            <a href="/guides" class="hover:text-accent-blue">Guides</a>
            <span class="mx-2">/</span>
            <a href={`/guides/${guideSlug}`} class="hover:text-accent-blue">{guideTitle}</a>
            <span class="mx-2">/</span>
            <span>{partData.title}</span>
          </nav>

          <div class="flex flex-col md:grid md:grid-cols-3 gap-8">
            <div class="order-2 md:order-1 md:col-span-2">
              <article id="article-content">
                <header class="mb-8">
                  <h1 class="mb-4">{partData.title}</h1>
                  <div class="flex flex-wrap items-center gap-4 text-sm text-fg-muted">
                    <time datetime={partData.date}>{formattedDate}</time>
                    <span>â€¢</span>
                    <span>{readingTime} min read</span>
                  </div>
                </header>
                <div class="prose prose-invert max-w-none">
                  <Content />
                </div>
                <PartNav
                  previousPart={previousPart}
                  nextPart={nextPart}
                  guideSlug={guideSlug}
                  guideTitle={guideTitle}
                />
              </article>
            </div>
            <div class="order-1 md:order-2">
              <GuideNav
                parts={navParts}
                currentPart={part.slug.split('/').pop()}
                guideSlug={guideSlug}
              />
            </div>
          </div>
        </div>
      </Container>
    </main>
    <Footer />
  </div>
</Layout>

<script>
  function updateReadingProgress() {
    const article = document.getElementById('article-content');
    const progressBar = document.getElementById('reading-progress-bar');
    
    if (!article || !progressBar) return;

    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    
    // Calculate how much of the article has been scrolled past
    const scrolled = Math.max(0, scrollTop - articleTop + windowHeight);
    const total = articleHeight + windowHeight;
    const progress = Math.min(100, (scrolled / total) * 100);
    
    progressBar.style.width = `${progress}%`;
  }

  // Throttle scroll events for performance
  let ticking = false;
  function onScroll() {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateReadingProgress();
        ticking = false;
      });
      ticking = true;
    }
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      updateReadingProgress();
      window.addEventListener('scroll', onScroll, { passive: true });
    });
  } else {
    updateReadingProgress();
    window.addEventListener('scroll', onScroll, { passive: true });
  }

  // Re-initialize on navigation (Astro View Transitions)
  document.addEventListener('astro:page-load', () => {
    updateReadingProgress();
    window.addEventListener('scroll', onScroll, { passive: true });
  });
</script>


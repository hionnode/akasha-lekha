---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/layout/Header.astro';
import Footer from '../../../components/layout/Footer.astro';
import Container from '../../../components/layout/Container.astro';
import SEO from '../../../components/shared/SEO.astro';
import TagPill from '../../../components/blog/TagPill.astro';
import GuideNav from '../../../components/guides/GuideNav.astro';
import { calculateReadingTime } from '../../../utils/readingTime';

export async function getStaticPaths() {
  const guides = await getCollection('guides');
  const guideIndexes = guides.filter((guide) => 'parts' in guide.data);

  return guideIndexes.map((guide) => {
    const guideSlug = guide.slug.split('/')[0];
    const parts = guides
      .filter((g) => g.slug.startsWith(guideSlug) && 'part' in g.data)
      .sort((a, b) => (a.data as { part: number }).part - (b.data as { part: number }).part);

    return {
      params: { guideSlug: guideSlug },
      props: { guide, parts },
    };
  });
}

interface Props {
  guide: Awaited<ReturnType<typeof getCollection<'guides'>>>[number];
  parts: Awaited<ReturnType<typeof getCollection<'guides'>>>[number][];
}

const { guide, parts } = Astro.props;
const guideData = guide.data as { title: string; description: string; tags: string[]; parts: Array<{ slug: string; title: string }> };
const totalReadTime = parts.reduce((acc, part) => acc + calculateReadingTime(part.body), 0);
---

<Layout title={`${guideData.title} | works-on-my.cloud`}>
  <SEO title={guideData.title} description={guideData.description} />
  <div class="min-h-screen flex flex-col">
    <Header />
    <main class="flex-1">
      <Container class="py-12">
        <div class="max-w-4xl mx-auto">
          <header class="mb-12">
            <h1 class="mb-4">{guideData.title}</h1>
            <p class="text-lg text-fg-secondary leading-relaxed mb-6 whitespace-pre-line">
              {guideData.description}
            </p>
            <div class="flex flex-wrap items-center gap-4 mb-6">
              <span class="text-sm text-fg-muted">{parts.length} parts</span>
              <span class="text-sm text-fg-muted">â€¢</span>
              <span class="text-sm text-fg-muted">{totalReadTime} min total read</span>
            </div>
            <div class="flex flex-wrap gap-2">
              {guideData.tags.map((tag) => (
                <TagPill tag={tag} />
              ))}
            </div>
          </header>

          <div class="grid md:grid-cols-3 gap-8">
            <div class="md:col-span-2">
              <h2 class="text-2xl font-semibold mb-6">Parts</h2>
              <ol class="space-y-4">
                {parts.map((part, index) => {
                  const partData = part.data as { title: string; date: string };
                  const partReadTime = calculateReadingTime(part.body);
                  return (
                    <li>
                      <a
                        href={`/guides/${guide.slug.split('/')[0]}/${part.slug.split('/').pop()}`}
                        class="block p-4 border border-border bg-bg-secondary hover:bg-bg-tertiary hover:border-accent-blue transition-colors rounded"
                      >
                        <div class="flex items-start justify-between">
                          <div>
                            <span class="text-fg-muted text-sm font-semibold mr-2">
                              Part {index + 1}:
                            </span>
                            <span class="font-semibold">{partData.title}</span>
                          </div>
                          <span class="text-xs text-fg-muted">{partReadTime} min</span>
                        </div>
                      </a>
                    </li>
                  );
                })}
              </ol>
            </div>
            <div>
              <GuideNav parts={guideData.parts} guideSlug={guide.slug.split('/')[0]} />
            </div>
          </div>
        </div>
      </Container>
    </main>
    <Footer />
  </div>
</Layout>


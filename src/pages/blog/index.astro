---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import PostList from '../../components/blog/PostList.astro';
import BlogSidebar from '../../components/layout/BlogSidebar.astro';
import MobileSidebarDrawers from '../../components/layout/MobileSidebarDrawers.astro';
import VimShortcuts from '../../components/shared/VimShortcuts.astro';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const posts = allPosts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Get the tag from URL query parameter
const url = Astro.url;
const currentTag = url.searchParams.get('tag');

// Filter posts by tag if one is selected
const filteredPosts = currentTag
  ? posts.filter((post) => post.data.tags.includes(currentTag))
  : posts;

// Get featured posts for right sidebar
const featuredPosts = posts.filter((post) => post.data.featured).slice(0, 5);
---

<Layout
  title="Blog | works-on-my.cloud"
  description="Technical articles about cloud infrastructure, DevOps, security, and observability"
>
  <div class="min-h-screen flex flex-col">
    <Header />
    <main id="main-content" class="flex-1 py-12">
      <!-- Three-column grid layout -->
      <div class="blog-grid-layout">
        <!-- Left Sidebar: Tag Navigation with Search & Sort -->
        <div class="blog-grid-left">
          <BlogSidebar allPosts={allPosts} currentTag={currentTag} />
        </div>

        <!-- Center: Blog Post List -->
        <div class="blog-grid-center">
          <div class="mb-8">
            <h1 class="mb-4">
              {currentTag ? `Posts tagged with "${currentTag}"` : 'Blog'}
            </h1>
            {
              currentTag && (
                <p class="text-fg-secondary">
                  Showing {filteredPosts.length} {filteredPosts.length === 1 ? 'post' : 'posts'}
                </p>
              )
            }
          </div>

          <div id="blog-content">
            <PostList posts={filteredPosts} />
          </div>

          <div id="empty-state" class="hidden text-center py-12">
            <p class="text-fg-secondary text-lg mb-4">üîç No posts found matching your filters.</p>
            <button
              id="clear-filters-empty"
              class="px-4 py-2 text-accent-blue hover:text-accent-cyan hover:bg-accent-blue/10 transition-colors underline rounded"
            >
              Clear all filters
            </button>
          </div>
        </div>

        <!-- Right Sidebar: Featured Posts / Recent Activity -->
        <div class="blog-grid-right">
          <aside class="hidden xl:block w-[280px] sticky top-24 self-start">
            <div class="bg-bg-secondary/50 backdrop-blur-sm border border-border rounded-lg p-4">
              <h2
                class="text-xs font-semibold text-fg-muted uppercase tracking-wider mb-4 flex items-center gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                  ></polygon>
                </svg>
                Featured Posts
              </h2>
              {
                featuredPosts.length > 0 ? (
                  <nav class="space-y-3">
                    {featuredPosts.map((post) => (
                      <a
                        href={`/blog/${post.slug}`}
                        class="block p-3 rounded bg-bg-tertiary/50 hover:bg-bg-tertiary hover:border-accent-blue border border-transparent transition-all group"
                      >
                        <h3 class="text-sm font-semibold text-fg-primary group-hover:text-accent-blue transition-colors leading-snug mb-1 line-clamp-2">
                          {post.data.title}
                        </h3>
                        <p class="text-xs text-fg-muted line-clamp-2">{post.data.excerpt}</p>
                        <div class="mt-2 flex items-center gap-1.5 flex-wrap">
                          {post.data.tags.slice(0, 2).map((tag) => (
                            <span class="text-[10px] uppercase tracking-wider text-accent-cyan">
                              {tag}
                            </span>
                          ))}
                        </div>
                      </a>
                    ))}
                  </nav>
                ) : (
                  <p class="text-sm text-fg-muted">No featured posts yet.</p>
                )
              }
            </div>

            <!-- Quick Stats -->
            <div
              class="mt-4 bg-bg-secondary/50 backdrop-blur-sm border border-border rounded-lg p-4"
            >
              <h2 class="text-xs font-semibold text-fg-muted uppercase tracking-wider mb-3">
                Quick Stats
              </h2>
              <div class="space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-fg-secondary">Total Posts</span>
                  <span class="font-semibold text-accent-blue">{posts.length}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-fg-secondary">Featured</span>
                  <span class="font-semibold text-accent-cyan">{featuredPosts.length}</span>
                </div>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </main>
    <Footer />
    <VimShortcuts />
    <MobileSidebarDrawers />
  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Handle clear filters button
  document.addEventListener('DOMContentLoaded', () => {
    const clearButton = document.getElementById('clear-filters-empty');
    if (clearButton) {
      clearButton.addEventListener('click', () => {
        window.location.href = '/blog';
      });
    }
  });

  // Re-initialize on navigation
  document.addEventListener('astro:page-load', () => {
    const clearButton = document.getElementById('clear-filters-empty');
    if (clearButton) {
      clearButton.addEventListener('click', () => {
        window.location.href = '/blog';
      });
    }
  });
</script>

---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import Container from '../components/layout/Container.astro';
import PostList from '../components/blog/PostList.astro';
import TerminalHero from '../components/landing/TerminalHero.astro';
import VimShortcuts from '../components/shared/VimShortcuts.astro';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const featuredPosts = allPosts
  .filter((post) => post.data.featured)
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 5);

// Exclude featured posts from latest posts to avoid overlap
const featuredSlugs = new Set(featuredPosts.map((post) => post.slug));
const latestPosts = allPosts
  .filter((post) => !featuredSlugs.has(post.slug))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 5);
---

<Layout title="works-on-my.cloud">
  <div class="min-h-screen flex flex-col">
    <Header />
    <main id="main-content" class="flex-1">
      <Container class="py-12">
        <!-- Terminal Hero Section -->
        <section id="terminal-section" class="mb-12">
          <TerminalHero client:load />
        </section>

        <div id="content-below-terminal" class="hidden opacity-0 transition-opacity duration-1000">
          {
            featuredPosts.length > 0 && (
              <section class="mb-12">
                <h2 class="mb-6 text-2xl font-semibold">Featured</h2>
                <PostList posts={featuredPosts} />
              </section>
            )
          }

          <section>
            <h2 class="mb-6 text-2xl font-semibold">Latest</h2>
            <PostList posts={latestPosts} />
          </section>
        </div>
      </Container>
    </main>
    <Footer />
    <VimShortcuts />
  </div>
</Layout>

<script>
  function showContentSkeletons() {
    const featuredSkeleton = document.getElementById('featured-skeleton');
    const featuredContent = document.getElementById('featured-content');
    const latestSkeleton = document.getElementById('latest-skeleton');
    const latestContent = document.getElementById('latest-content');

    // Show skeletons initially
    if (featuredSkeleton && featuredContent) {
      featuredSkeleton.classList.remove('hidden');
      featuredContent.classList.add('hidden');
    }

    if (latestSkeleton && latestContent) {
      latestSkeleton.classList.remove('hidden');
      latestContent.classList.add('hidden');
    }

    // Fade to content after short delay
    setTimeout(() => {
      if (featuredSkeleton && featuredContent) {
        featuredSkeleton.classList.add('hidden');
        featuredContent.classList.remove('hidden');
      }

      if (latestSkeleton && latestContent) {
        latestSkeleton.classList.add('hidden');
        latestContent.classList.remove('hidden');
      }
    }, 400);
  }

  // Wait for content to become visible (after terminal animation)
  function initSkeletons() {
    const contentBelow = document.getElementById('content-below-terminal');
    if (contentBelow && !contentBelow.classList.contains('hidden')) {
      showContentSkeletons();
    } else {
      // Watch for when content becomes visible
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const target = mutation.target as HTMLElement;
            if (!target.classList.contains('hidden')) {
              showContentSkeletons();
              observer.disconnect();
            }
          }
        });
      });

      if (contentBelow) {
        observer.observe(contentBelow, { attributes: true });
      }
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initSkeletons, 100);
    });
  } else {
    setTimeout(initSkeletons, 100);
  }

  // Handle Astro View Transitions
  document.addEventListener('astro:page-load', () => {
    setTimeout(initSkeletons, 100);
  });
</script>

---
import { extractTagsWithCounts } from '../../utils/tagNavigation';

interface Props {
  allPosts: Array<{
    slug: string;
    data: {
      title: string;
      tags: string[];
      date: string;
      excerpt: string;
      draft?: boolean;
    };
  }>;
  currentTag?: string | null;
}

const { allPosts, currentTag = null } = Astro.props;

// Get tag navigation data
const tagData = extractTagsWithCounts(allPosts.filter((p) => !p.data.draft));
const tags = tagData.sortedByFrequency;
---

<aside
  id="blog-sidebar"
  class="w-full lg:w-[250px] sticky top-24 self-start max-h-[calc(100vh-8rem)]"
>
  <div
    class="bg-bg-secondary/50 backdrop-blur-sm border border-border rounded-lg p-4 overflow-hidden flex flex-col max-h-[calc(100vh-8rem)]"
  >
    <!-- Search -->
    <div class="mb-4">
      <div class="relative">
        <input
          type="text"
          id="sidebar-search"
          placeholder="Search posts..."
          class="w-full px-3 py-2 pl-9 bg-bg-tertiary border border-border rounded text-sm text-fg-primary placeholder-fg-muted focus:outline-none focus:ring-2 focus:ring-accent-blue focus:border-transparent transition-all"
        />
        <svg
          class="absolute left-3 top-2.5 w-4 h-4 text-fg-muted"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>

    <!-- Sort Options -->
    <div class="mb-4 pb-4 border-b border-border">
      <label
        for="sidebar-sort"
        class="block text-xs font-semibold text-fg-muted uppercase tracking-wider mb-2"
      >
        Sort By
      </label>
      <select
        id="sidebar-sort"
        class="w-full px-3 py-2 bg-bg-tertiary border border-border rounded text-sm text-fg-primary focus:outline-none focus:ring-2 focus:ring-accent-blue focus:border-transparent transition-all cursor-pointer"
      >
        <option value="date-desc">Newest First</option>
        <option value="date-asc">Oldest First</option>
        <option value="title-asc">Title (A-Z)</option>
        <option value="title-desc">Title (Z-A)</option>
      </select>
    </div>

    <!-- Tags -->
    <div class="flex-1 overflow-hidden flex flex-col">
      <h2
        class="text-xs font-semibold text-fg-muted uppercase tracking-wider mb-3 flex items-center justify-between"
      >
        <span>Filter by Tag</span>
        {
          currentTag && (
            <button
              id="clear-tag-filter"
              class="text-accent-blue hover:text-accent-cyan text-xs normal-case"
              title="Clear filter"
            >
              Clear
            </button>
          )
        }
      </h2>
      <nav class="space-y-1 overflow-y-auto sidebar-scroll flex-1">
        <a
          href="/blog"
          class={`block px-3 py-2 rounded text-sm transition-all ${
            !currentTag
              ? 'bg-accent-blue/20 text-accent-blue border border-accent-blue'
              : 'text-fg-secondary hover:bg-bg-tertiary hover:text-fg-primary border border-transparent'
          }`}
        >
          <div class="flex items-center justify-between">
            <span class="font-medium">All Posts</span>
            <span class="text-xs opacity-75">{allPosts.filter((p) => !p.data.draft).length}</span>
          </div>
        </a>
        {
          tags.map((tagInfo) => {
            const isActive = currentTag === tagInfo.tag;
            return (
              <a
                href={`/blog?tag=${encodeURIComponent(tagInfo.tag)}`}
                class={`block px-3 py-2 rounded text-sm transition-all ${
                  isActive
                    ? 'bg-accent-blue/20 text-accent-blue border border-accent-blue'
                    : 'text-fg-secondary hover:bg-bg-tertiary hover:text-fg-primary border border-transparent'
                }`}
                data-tag={tagInfo.tag}
              >
                <div class="flex items-center justify-between">
                  <span class="uppercase tracking-wide font-medium">{tagInfo.tag}</span>
                  <span class="text-xs opacity-75">{tagInfo.count}</span>
                </div>
              </a>
            );
          })
        }
      </nav>
    </div>
  </div>
</aside>

<style>
  .sidebar-scroll::-webkit-scrollbar {
    width: 4px;
  }

  .sidebar-scroll::-webkit-scrollbar-track {
    background: transparent;
  }

  .sidebar-scroll::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 2px;
  }

  .sidebar-scroll::-webkit-scrollbar-thumb:hover {
    background: var(--accent-blue);
  }
</style>

<script>
  function initBlogSidebar() {
    const searchInput = document.getElementById('sidebar-search') as HTMLInputElement;
    const sortSelect = document.getElementById('sidebar-sort') as HTMLSelectElement;
    const clearButton = document.getElementById('clear-tag-filter');

    if (!searchInput || !sortSelect) return;

    // Get all post cards
    const postCards = document.querySelectorAll('[data-post-card]');

    // Search functionality
    let searchTimeout: number;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = window.setTimeout(() => {
        const query = searchInput.value.toLowerCase().trim();
        filterAndSort(query, sortSelect.value);
      }, 300);
    });

    // Sort functionality
    sortSelect.addEventListener('change', () => {
      const query = searchInput.value.toLowerCase().trim();
      filterAndSort(query, sortSelect.value);
    });

    // Clear tag filter
    if (clearButton) {
      clearButton.addEventListener('click', () => {
        window.location.href = '/blog';
      });
    }

    function filterAndSort(searchQuery: string, sortBy: string) {
      const postsArray = Array.from(postCards) as HTMLElement[];

      // Filter by search
      const filteredPosts = postsArray.filter((card) => {
        if (!searchQuery) return true;

        const title = (card.getAttribute('data-title') || '').toLowerCase();
        const excerpt = (card.getAttribute('data-excerpt') || '').toLowerCase();
        const tags = (card.getAttribute('data-tags') || '').toLowerCase();

        return (
          title.includes(searchQuery) || excerpt.includes(searchQuery) || tags.includes(searchQuery)
        );
      });

      // Sort
      filteredPosts.sort((a, b) => {
        const aTitle = a.getAttribute('data-title') || '';
        const bTitle = b.getAttribute('data-title') || '';
        const aDate = a.getAttribute('data-date') || '';
        const bDate = b.getAttribute('data-date') || '';

        switch (sortBy) {
          case 'date-desc':
            return new Date(bDate).getTime() - new Date(aDate).getTime();
          case 'date-asc':
            return new Date(aDate).getTime() - new Date(bDate).getTime();
          case 'title-asc':
            return aTitle.localeCompare(bTitle);
          case 'title-desc':
            return bTitle.localeCompare(aTitle);
          default:
            return 0;
        }
      });

      // Hide all posts first
      postsArray.forEach((card) => {
        card.style.display = 'none';
      });

      // Show filtered and sorted posts
      const container = document.getElementById('post-list-container');
      if (container) {
        filteredPosts.forEach((card) => {
          card.style.display = '';
          container.appendChild(card);
        });
      }

      // Show/hide empty state
      const emptyState = document.getElementById('empty-state');
      if (emptyState) {
        if (filteredPosts.length === 0) {
          emptyState.classList.remove('hidden');
        } else {
          emptyState.classList.add('hidden');
        }
      }
    }

    // Initialize with current sort
    // URLSearchParams available for future query string handling
    // const urlParams = new URLSearchParams(window.location.search);
    const savedSort = localStorage.getItem('blog-sort-preference');
    if (savedSort) {
      sortSelect.value = savedSort;
    }

    // Save sort preference
    sortSelect.addEventListener('change', () => {
      localStorage.setItem('blog-sort-preference', sortSelect.value);
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBlogSidebar);
  } else {
    initBlogSidebar();
  }

  // Re-initialize on navigation
  document.addEventListener('astro:page-load', initBlogSidebar);
</script>

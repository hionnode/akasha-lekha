---
interface Props {
  content: string;
}

const { content } = Astro.props;
---

<!-- Desktop: Sticky TOC on the side -->
<div id="table-of-contents" class="hidden lg:block fixed right-8 top-24 w-64 max-h-[calc(100vh-8rem)] overflow-y-auto">
  <div class="p-4 bg-bg-secondary border border-border rounded-lg">
    <h2 class="text-sm font-semibold mb-3 text-fg-primary uppercase tracking-wider">Table of Contents</h2>
    <nav id="toc-list" class="space-y-1.5">
      <!-- TOC will be populated by JavaScript -->
    </nav>
  </div>
</div>

<!-- Mobile: Collapsible TOC at top of content -->
<div id="table-of-contents-mobile" class="lg:hidden mb-8">
  <button
    id="toc-toggle"
    class="w-full p-4 bg-bg-secondary border border-border rounded-lg text-left flex items-center justify-between hover:border-accent-blue transition-colors"
  >
    <span class="text-sm font-semibold text-fg-primary uppercase tracking-wider">ðŸ“‘ Table of Contents</span>
    <svg id="toc-chevron" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-fg-secondary transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>
  <div id="toc-content-mobile" class="hidden mt-2 p-4 bg-bg-secondary border border-border rounded-lg">
    <nav id="toc-list-mobile" class="space-y-1.5">
      <!-- TOC will be populated by JavaScript -->
    </nav>
  </div>
</div>

<style>
  #table-of-contents::-webkit-scrollbar {
    width: 6px;
  }

  #table-of-contents::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
    border-radius: 3px;
  }

  #table-of-contents::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  #table-of-contents::-webkit-scrollbar-thumb:hover {
    background: var(--accent-blue);
  }

  .toc-link {
    display: block;
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--fg-secondary);
    transition: color 0.2s, border-color 0.2s;
    padding: 0.25rem 0.5rem;
    border-left: 2px solid transparent;
    border-radius: 0.25rem;
  }

  .toc-link:hover {
    color: var(--accent-cyan);
    background: var(--bg-tertiary);
  }

  .toc-link.active {
    color: var(--accent-blue);
    border-left-color: var(--accent-blue);
    background: var(--bg-tertiary);
    font-weight: 600;
  }

  .toc-link.h3 {
    margin-left: 1rem;
    font-size: 0.8125rem;
  }
</style>

<script>
  function generateTOC() {
    const tocList = document.getElementById('toc-list');
    const tocListMobile = document.getElementById('toc-list-mobile');
    const article = document.getElementById('article-content');
    
    if (!article) return;

    // Find all h2 and h3 headings in the article (excluding the title)
    const headings = article.querySelectorAll('.prose h2, .prose h3');
    
    if (headings.length === 0) {
      // Hide TOC if no headings found
      const tocContainer = document.getElementById('table-of-contents');
      const tocContainerMobile = document.getElementById('table-of-contents-mobile');
      if (tocContainer) tocContainer.style.display = 'none';
      if (tocContainerMobile) tocContainerMobile.style.display = 'none';
      return;
    }

    let tocHTML = '';

    headings.forEach((heading, index) => {
      const id = heading.id || `heading-${index}`;
      const level = heading.tagName.toLowerCase();
      const text = heading.textContent || '';
      
      // Set ID on heading if it doesn't have one
      if (!heading.id) {
        heading.id = id;
      }

      // Create anchor link
      const levelClass = level === 'h3' ? 'h3' : '';
      tocHTML += `
        <a
          href="#${id}"
          class="toc-link ${levelClass}"
          data-toc-item
          data-heading-id="${id}"
        >
          ${text}
        </a>
      `;
    });

    if (tocList) tocList.innerHTML = tocHTML;
    if (tocListMobile) tocListMobile.innerHTML = tocHTML;

    // Smooth scroll behavior and active highlighting
    setupTOCInteraction();
  }

  function setupTOCInteraction() {
    const tocLinks = document.querySelectorAll('a[data-toc-item]');
    
    // Smooth scroll on click
    tocLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = (link as HTMLAnchorElement).getAttribute('href')?.substring(1);
        if (targetId) {
          const target = document.getElementById(targetId);
          if (target) {
            const headerOffset = 100; // Account for fixed header
            const elementPosition = target.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

            window.scrollTo({
              top: offsetPosition,
              behavior: 'smooth',
            });

            // Close mobile TOC after navigation
            const tocContentMobile = document.getElementById('toc-content-mobile');
            if (tocContentMobile && !tocContentMobile.classList.contains('hidden')) {
              tocContentMobile.classList.add('hidden');
              const chevron = document.getElementById('toc-chevron');
              if (chevron) chevron.style.transform = '';
            }
          }
        }
      });
    });

    // Intersection Observer for active highlighting
    const observerOptions = {
      root: null,
      rootMargin: '-100px 0px -66%',
      threshold: 0,
    };

    const observerCallback: IntersectionObserverCallback = (entries) => {
      entries.forEach((entry) => {
        const id = entry.target.id;
        const tocLink = document.querySelector(`a[data-heading-id="${id}"]`);
        
        if (entry.isIntersecting) {
          // Remove active class from all links
          document.querySelectorAll('a[data-toc-item]').forEach((link) => {
            link.classList.remove('active');
          });
          
          // Add active class to current link
          if (tocLink) {
            tocLink.classList.add('active');
          }
        }
      });
    };

    const observer = new IntersectionObserver(observerCallback, observerOptions);

    // Observe all headings
    const article = document.getElementById('article-content');
    if (article) {
      const headings = article.querySelectorAll('.prose h2, .prose h3');
      headings.forEach((heading) => observer.observe(heading));
    }

    // Mobile TOC toggle
    const tocToggle = document.getElementById('toc-toggle');
    const tocContentMobile = document.getElementById('toc-content-mobile');
    const tocChevron = document.getElementById('toc-chevron');

    if (tocToggle && tocContentMobile && tocChevron) {
      tocToggle.addEventListener('click', () => {
        const isHidden = tocContentMobile.classList.contains('hidden');
        if (isHidden) {
          tocContentMobile.classList.remove('hidden');
          tocChevron.style.transform = 'rotate(180deg)';
        } else {
          tocContentMobile.classList.add('hidden');
          tocChevron.style.transform = '';
        }
      });
    }
  }

  // Initialize TOC
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', generateTOC);
  } else {
    generateTOC();
  }

  // Re-initialize on navigation (Astro View Transitions)
  document.addEventListener('astro:page-load', generateTOC);
</script>

---
// This component enhances all code blocks on the page with copy buttons, file headers, terminal styling, and collapsible functionality
---

<script>
  function enhanceCodeBlocks() {
    const codeBlocks = document.querySelectorAll('.prose pre');

    codeBlocks.forEach((pre) => {
      // Skip if already enhanced
      if (pre.parentElement?.classList.contains('code-block-wrapper')) {
        return;
      }

      // Get code element
      const code = pre.querySelector('code');
      const codeText = code?.textContent || '';

      // Count lines in code block
      const lineCount = codeText.split('\n').length;

      // Detect ASCII art/diagrams by checking for box-drawing characters
      const hasBoxDrawing = /[┌┐└┘├┤┬┴┼─│╔╗╚╝╠╣╦╩╬═║▲▼◄►▶◀△▽◁▷┃━┏┓┗┛┣┫┳┻╋]/.test(codeText);
      const isAsciiArt = hasBoxDrawing;

      // Check for data attributes added by remark plugins
      const title = code?.getAttribute('data-title');
      const isTerminal = code?.getAttribute('data-terminal') === 'true';

      // Create wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';

      // Wrap the pre element
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // Add terminal header if terminal flag is present
      if (isTerminal) {
        const terminalHeader = document.createElement('div');
        terminalHeader.className = 'terminal-window';
        terminalHeader.innerHTML = `
          <div class="terminal-controls">
            <div class="terminal-dot"></div>
            <div class="terminal-dot"></div>
            <div class="terminal-dot"></div>
          </div>
          <span class="terminal-label">Terminal</span>
        `;
        wrapper.insertBefore(terminalHeader, pre);
      }
      // Add file header if title attribute is present
      else if (title) {
        const header = document.createElement('div');
        header.className = 'code-block-header';
        header.innerHTML = `
          <span class="file-path">
            <span class="file-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
            </span>
            ${title}
          </span>
        `;
        wrapper.insertBefore(header, pre);
      }

      // Create collapse/expand button
      const collapseButton = document.createElement('button');
      collapseButton.className = 'collapse-button';
      collapseButton.setAttribute('aria-label', 'Toggle code block');

      // Auto-collapse only non-ASCII code blocks with >20 lines
      const shouldAutoCollapse = lineCount > 20 && !isAsciiArt;
      collapseButton.setAttribute('aria-expanded', shouldAutoCollapse ? 'false' : 'true');

      // Set initial state based on line count and content type
      if (shouldAutoCollapse) {
        pre.classList.add('collapsed');
      }

      // Update button text
      const updateCollapseButton = (isCollapsed: boolean) => {
        collapseButton.innerHTML = isCollapsed
          ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg><span>Expand (${lineCount} lines)</span>`
          : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg><span>Collapse</span>`;
      };

      updateCollapseButton(shouldAutoCollapse);

      // Add collapse button click handler
      collapseButton.addEventListener('click', () => {
        const isCollapsed = pre.classList.toggle('collapsed');
        collapseButton.setAttribute('aria-expanded', !isCollapsed ? 'true' : 'false');
        updateCollapseButton(isCollapsed);
      });

      wrapper.appendChild(collapseButton);

      // Create copy button
      const copyButton = document.createElement('button');
      copyButton.className = 'copy-button';
      copyButton.textContent = 'Copy';
      copyButton.setAttribute('aria-label', 'Copy code to clipboard');

      // Add click handler
      copyButton.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(codeText);
          copyButton.textContent = 'Copied!';
          copyButton.classList.add('copied');

          setTimeout(() => {
            copyButton.textContent = 'Copy';
            copyButton.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
          copyButton.textContent = 'Failed';
          setTimeout(() => {
            copyButton.textContent = 'Copy';
          }, 2000);
        }
      });

      wrapper.appendChild(copyButton);
    });
  }

  // Run on page load
  document.addEventListener('astro:page-load', enhanceCodeBlocks);

  // Also run immediately in case astro:page-load already fired
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    enhanceCodeBlocks();
  }
</script>

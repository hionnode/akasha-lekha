---
// Vim-style keyboard shortcuts component
---

<div id="vim-shortcuts" class="fixed bottom-4 right-4 z-50">
  <!-- Toggle button -->
  <button
    id="vim-toggle"
    class="bg-bg-secondary border border-accent-blue text-accent-blue px-3 py-2 rounded-lg shadow-lg hover:bg-accent-blue/10 transition-all flex items-center gap-2 text-sm font-mono"
    aria-label="Toggle keyboard shortcuts"
  >
    <span class="text-accent-cyan">⌨️</span>
    <span>?</span>
  </button>

  <!-- Shortcuts panel -->
  <div
    id="vim-panel"
    class="absolute bottom-full right-0 mb-2 w-80 bg-bg-secondary border-2 border-accent-blue rounded-lg shadow-2xl p-4 hidden"
  >
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-semibold uppercase tracking-wider text-accent-blue flex items-center gap-2">
        <span class="text-accent-cyan">⌨️</span>
        Vim Shortcuts
      </h3>
      <button
        id="vim-close"
        class="text-fg-muted hover:text-accent-blue transition-colors"
        aria-label="Close shortcuts"
      >
        ×
      </button>
    </div>

    <div class="space-y-3 text-sm">
      <!-- Navigation -->
      <div>
        <div class="text-xs text-accent-cyan uppercase tracking-wide mb-2 font-semibold">Navigation</div>
        <div class="space-y-1.5">
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Scroll down</span>
            <kbd class="kbd">j</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Scroll up</span>
            <kbd class="kbd">k</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Half page down</span>
            <kbd class="kbd">d</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Half page up</span>
            <kbd class="kbd">u</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Top of page</span>
            <kbd class="kbd">g g</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Bottom of page</span>
            <kbd class="kbd">G</kbd>
          </div>
        </div>
      </div>

      <!-- Blog Navigation -->
      <div>
        <div class="text-xs text-accent-cyan uppercase tracking-wide mb-2 font-semibold">Blog</div>
        <div class="space-y-1.5">
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Go to blog index</span>
            <kbd class="kbd">g b</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Go to home</span>
            <kbd class="kbd">g h</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Next post (series)</span>
            <kbd class="kbd">]</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Previous post (series)</span>
            <kbd class="kbd">[</kbd>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div>
        <div class="text-xs text-accent-cyan uppercase tracking-wide mb-2 font-semibold">Actions</div>
        <div class="space-y-1.5">
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Search</span>
            <kbd class="kbd">/</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Copy link</span>
            <kbd class="kbd">y y</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Show shortcuts</span>
            <kbd class="kbd">?</kbd>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-fg-secondary">Escape/Cancel</span>
            <kbd class="kbd">Esc</kbd>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4 pt-3 border-t border-border text-xs text-fg-muted">
      Press <kbd class="kbd-sm">?</kbd> to toggle this panel
    </div>
  </div>
</div>

<style>
  .kbd {
    padding: 0.25rem 0.5rem;
    background-color: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-family: 'Inconsolata', monospace;
    color: var(--color-accent-blue);
    min-width: 2rem;
    text-align: center;
    display: inline-block;
  }
  
  .kbd-sm {
    padding: 0.125rem 0.375rem;
    background-color: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-family: 'Inconsolata', monospace;
    color: var(--color-accent-blue);
  }
</style>

<script>
  function initVimShortcuts() {
    const toggle = document.getElementById('vim-toggle');
    const panel = document.getElementById('vim-panel');
    const closeBtn = document.getElementById('vim-close');
    
    if (!toggle || !panel || !closeBtn) return;

    // Toggle panel
    const togglePanel = () => {
      panel.classList.toggle('hidden');
    };

    toggle.addEventListener('click', togglePanel);
    closeBtn.addEventListener('click', togglePanel);

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !panel.classList.contains('hidden')) {
        panel.classList.add('hidden');
      }
    });

    // Vim shortcuts
    let lastKey = '';
    let lastKeyTime = 0;

    document.addEventListener('keydown', (e) => {
      // Don't interfere with input fields
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
        return;
      }

      const now = Date.now();
      const timeSinceLastKey = now - lastKeyTime;

      // Reset combo if too much time passed
      if (timeSinceLastKey > 1000) {
        lastKey = '';
      }

      const currentCombo = lastKey + e.key;

      // Prevent default for our shortcuts
      const shortcuts = ['j', 'k', 'd', 'u', 'G', '/', '?', '[', ']', 'y'];
      if (shortcuts.includes(e.key) || currentCombo === 'gg' || currentCombo === 'gb' || currentCombo === 'gh' || currentCombo === 'yy') {
        e.preventDefault();
      }

      // Scrolling
      if (e.key === 'j') {
        window.scrollBy({ top: 100, behavior: 'smooth' });
      } else if (e.key === 'k') {
        window.scrollBy({ top: -100, behavior: 'smooth' });
      } else if (e.key === 'd') {
        window.scrollBy({ top: window.innerHeight / 2, behavior: 'smooth' });
      } else if (e.key === 'u') {
        window.scrollBy({ top: -window.innerHeight / 2, behavior: 'smooth' });
      } else if (e.key === 'G') {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      } else if (currentCombo === 'gg') {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        lastKey = '';
        return;
      }

      // Navigation
      else if (currentCombo === 'gb') {
        window.location.href = '/blog';
        lastKey = '';
        return;
      } else if (currentCombo === 'gh') {
        window.location.href = '/';
        lastKey = '';
        return;
      }

      // Series navigation
      else if (e.key === ']') {
        // Find next series link
        const nextLink = document.querySelector('a[href*="/blog/"]:has-text("Next")') as HTMLAnchorElement;
        if (nextLink) nextLink.click();
      } else if (e.key === '[') {
        // Find previous series link
        const prevLink = document.querySelector('a[href*="/blog/"]:has-text("Previous")') as HTMLAnchorElement;
        if (prevLink) prevLink.click();
      }

      // Actions
      else if (e.key === '/') {
        const searchInput = document.querySelector('input[type="text"]') as HTMLInputElement;
        if (searchInput) {
          searchInput.focus();
          searchInput.select();
        }
      } else if (e.key === '?') {
        togglePanel();
      } else if (currentCombo === 'yy') {
        // Copy current URL
        navigator.clipboard.writeText(window.location.href);
        // Show feedback
        const feedback = document.createElement('div');
        feedback.className = 'fixed bottom-20 right-4 bg-accent-blue text-bg-primary px-4 py-2 rounded-lg shadow-lg text-sm font-mono z-50';
        feedback.textContent = 'Link copied!';
        document.body.appendChild(feedback);
        setTimeout(() => feedback.remove(), 2000);
        lastKey = '';
        return;
      }

      // Update last key for combos
      lastKey = e.key;
      lastKeyTime = now;
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVimShortcuts);
  } else {
    initVimShortcuts();
  }

  // Re-initialize on navigation (Astro View Transitions)
  document.addEventListener('astro:page-load', initVimShortcuts);
</script>


---
interface Props {
  defaultActive?: string;
  class?: string;
}

const { defaultActive, class: className = '' } = Astro.props;
---

<div class={`panel-switcher-wrapper ${className}`} data-default-active={defaultActive}>
  <div class="panel-switcher-tabs" role="tablist" aria-label="Panel switcher">
    <!-- Tabs will be generated by client-side script -->
  </div>
  <div class="panel-switcher-content">
    <slot />
  </div>
</div>

<script>
  function initPanelSwitcher() {
    const wrappers = document.querySelectorAll('.panel-switcher-wrapper');

    wrappers.forEach((wrapper) => {
      const content = wrapper.querySelector('.panel-switcher-content');
      const tabsContainer = wrapper.querySelector('.panel-switcher-tabs');
      if (!content || !tabsContainer) return;

      // Find all panel elements
      const panels = Array.from(content.children).filter((child) =>
        child.hasAttribute('data-panel-label')
      );

      if (panels.length === 0) return;

      // Extract panel info
      const panelData = panels.map((panel, index) => {
        const label = panel.getAttribute('data-panel-label') || `Panel ${index + 1}`;
        const value =
          panel.getAttribute('data-panel-value') || label.toLowerCase().replace(/\s+/g, '-');
        return { label, value, element: panel };
      });

      // Get default active panel
      const defaultActive = wrapper.getAttribute('data-default-active') || panelData[0].value;
      let activeValue = defaultActive;

      // Create tabs
      tabsContainer.innerHTML = '';
      panelData.forEach(({ label, value }) => {
        const button = document.createElement('button');
        button.className = `panel-switcher-tab ${value === activeValue ? 'active' : ''}`;
        button.textContent = label;
        button.setAttribute('role', 'tab');
        button.setAttribute('aria-selected', value === activeValue ? 'true' : 'false');
        button.setAttribute('data-panel-value', value);
        button.setAttribute('aria-controls', `panel-${value}`);
        button.setAttribute('id', `tab-${value}`);

        button.addEventListener('click', () => {
          // Add ripple effect
          button.classList.add('ripple');
          setTimeout(() => button.classList.remove('ripple'), 400);

          // Update active tab
          panelData.forEach(({ value: v }) => {
            const tab = tabsContainer.querySelector(`[data-panel-value="${v}"]`);
            const panel = content.querySelector(`[data-panel-value="${v}"]`);

            if (v === value) {
              tab?.classList.add('active');
              tab?.setAttribute('aria-selected', 'true');
              panel?.classList.remove('hidden');
              panel?.classList.add('entering');
              panel?.setAttribute('aria-hidden', 'false');
              // Remove entering class after animation
              setTimeout(() => panel?.classList.remove('entering'), 300);
              activeValue = value;
            } else {
              tab?.classList.remove('active');
              tab?.setAttribute('aria-selected', 'false');
              panel?.classList.add('hidden');
              panel?.classList.remove('entering');
              panel?.setAttribute('aria-hidden', 'true');
            }
          });

          // Update active indicator position
          updateActiveIndicator();
        });

        // Keyboard navigation
        button.addEventListener('keydown', (e) => {
          const currentIndex = panelData.findIndex((p) => p.value === activeValue);
          let newIndex = currentIndex;

          if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault();
            newIndex = (currentIndex + 1) % panelData.length;
          } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault();
            newIndex = (currentIndex - 1 + panelData.length) % panelData.length;
          } else if (e.key === 'Home') {
            e.preventDefault();
            newIndex = 0;
          } else if (e.key === 'End') {
            e.preventDefault();
            newIndex = panelData.length - 1;
          }

          if (newIndex !== currentIndex) {
            const newValue = panelData[newIndex].value;
            const newTab = tabsContainer.querySelector(
              `[data-panel-value="${newValue}"]`
            ) as HTMLButtonElement | null;
            newTab?.click();
            newTab?.focus();
          }
        });

        tabsContainer.appendChild(button);
      });

      // Function to update active indicator position
      const updateActiveIndicator = () => {
        const activeTab = tabsContainer.querySelector('.panel-switcher-tab.active') as HTMLElement;
        if (activeTab && tabsContainer) {
          const tabRect = activeTab.getBoundingClientRect();
          const containerRect = tabsContainer.getBoundingClientRect();
          const left = tabRect.left - containerRect.left + tabsContainer.scrollLeft;
          const width = tabRect.width;

          (tabsContainer as HTMLElement).style.setProperty('--indicator-left', `${left}px`);
          (tabsContainer as HTMLElement).style.setProperty('--indicator-width', `${width}px`);
        }
      };

      // Initialize panel visibility
      panelData.forEach(({ value, element }) => {
        element.setAttribute('id', `panel-${value}`);
        element.setAttribute('role', 'tabpanel');
        element.setAttribute('aria-labelledby', `tab-${value}`);

        if (value === activeValue) {
          element.classList.remove('hidden');
          element.setAttribute('aria-hidden', 'false');
        } else {
          element.classList.add('hidden');
          element.setAttribute('aria-hidden', 'true');
        }
      });

      // Set initial indicator position
      setTimeout(updateActiveIndicator, 0);

      // Update indicator on window resize
      window.addEventListener('resize', updateActiveIndicator);
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPanelSwitcher);
  } else {
    initPanelSwitcher();
  }

  // Re-initialize on navigation (Astro View Transitions)
  document.addEventListener('astro:page-load', initPanelSwitcher);
</script>

<style>
  .panel-switcher-wrapper {
    margin: 1.5rem 0;
    border: 2px solid var(--border);
    border-radius: 0.5rem;
    overflow: hidden;
    background: var(--bg-secondary);
  }

  .panel-switcher-tabs {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-bottom: 2px solid var(--border);
    flex-wrap: wrap;
    position: relative;
  }

  /* Active indicator line */
  .panel-switcher-tabs::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: var(--indicator-left, 0);
    width: var(--indicator-width, 0);
    height: 2px;
    background: var(--accent-blue);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1;
  }

  .panel-switcher-tab {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: transparent;
    border: 2px solid transparent;
    border-radius: 0.375rem;
    color: var(--fg-muted);
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: 'Inconsolata', monospace;
    outline: none;
    position: relative;
  }

  .panel-switcher-tab:hover {
    background: rgba(122, 162, 247, 0.1);
    color: var(--fg-secondary);
    border-color: rgba(122, 162, 247, 0.2);
  }

  /* Click feedback animation */
  .panel-switcher-tab:active {
    transform: scale(0.95);
  }

  .panel-switcher-tab:focus-visible {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
  }

  .panel-switcher-tab.active {
    background: rgba(122, 162, 247, 0.15);
    color: var(--accent-blue);
    border-color: var(--accent-blue);
    font-weight: 700;
  }

  /* Ripple effect on click */
  .panel-switcher-tab::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(122, 162, 247, 0.3);
    transform: translate(-50%, -50%);
    transition:
      width 0.4s ease,
      height 0.4s ease,
      opacity 0.4s ease;
    opacity: 0;
  }

  .panel-switcher-tab.ripple::before {
    width: 100%;
    height: 100%;
    opacity: 1;
  }

  .panel-switcher-content {
    position: relative;
    min-height: 100px;
    padding: 1.5rem;
  }

  /* Crossfade transition */
  .panel-switcher-content > [data-panel-label] {
    display: block;
    opacity: 1;
    transform: translateY(0);
    transition:
      opacity 0.2s ease-in-out,
      transform 0.2s ease-in-out;
  }

  .panel-switcher-content > [data-panel-label].hidden {
    display: none;
    opacity: 0;
    transform: translateY(8px);
  }

  .panel-switcher-content > [data-panel-label].entering {
    animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .panel-switcher-tabs {
      gap: 0.375rem;
      padding: 0.5rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .panel-switcher-tabs::-webkit-scrollbar {
      display: none;
    }

    .panel-switcher-tab {
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      min-height: 44px;
      flex-shrink: 0;
    }

    .panel-switcher-content {
      padding: 1rem;
    }
  }
</style>

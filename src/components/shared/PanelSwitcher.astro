---
interface Props {
  defaultActive?: string;
  class?: string;
}

const { defaultActive, class: className = '' } = Astro.props;
---

<div class={`panel-switcher-wrapper ${className}`} data-default-active={defaultActive}>
  <div class="panel-switcher-tabs" role="tablist" aria-label="Panel switcher">
    <!-- Tabs will be generated by client-side script -->
  </div>
  <div class="panel-switcher-content">
    <slot />
  </div>
</div>

<script>
  function initPanelSwitcher() {
    const wrappers = document.querySelectorAll('.panel-switcher-wrapper');

    wrappers.forEach((wrapper) => {
      const content = wrapper.querySelector('.panel-switcher-content');
      const tabsContainer = wrapper.querySelector('.panel-switcher-tabs');
      if (!content || !tabsContainer) return;

      // Find all panel elements
      const panels = Array.from(content.children).filter((child) =>
        child.hasAttribute('data-panel-label')
      );

      if (panels.length === 0) return;

      // Extract panel info
      const panelData = panels.map((panel, index) => {
        const label = panel.getAttribute('data-panel-label') || `Panel ${index + 1}`;
        const value =
          panel.getAttribute('data-panel-value') || label.toLowerCase().replace(/\s+/g, '-');
        return { label, value, element: panel };
      });

      // Get default active panel
      const defaultActive = wrapper.getAttribute('data-default-active') || panelData[0].value;
      let activeValue = defaultActive;

      // Create tabs
      tabsContainer.innerHTML = '';
      panelData.forEach(({ label, value }) => {
        const button = document.createElement('button');
        button.className = `panel-switcher-tab ${value === activeValue ? 'active' : ''}`;
        button.textContent = label;
        button.setAttribute('role', 'tab');
        button.setAttribute('aria-selected', value === activeValue ? 'true' : 'false');
        button.setAttribute('data-panel-value', value);
        button.setAttribute('aria-controls', `panel-${value}`);
        button.setAttribute('id', `tab-${value}`);

        button.addEventListener('click', () => {
          // Update active tab
          panelData.forEach(({ value: v }) => {
            const tab = tabsContainer.querySelector(`[data-panel-value="${v}"]`);
            const panel = content.querySelector(`[data-panel-value="${v}"]`);

            if (v === value) {
              tab?.classList.add('active');
              tab?.setAttribute('aria-selected', 'true');
              panel?.classList.remove('hidden');
              panel?.setAttribute('aria-hidden', 'false');
              activeValue = value;
            } else {
              tab?.classList.remove('active');
              tab?.setAttribute('aria-selected', 'false');
              panel?.classList.add('hidden');
              panel?.setAttribute('aria-hidden', 'true');
            }
          });
        });

        // Keyboard navigation
        button.addEventListener('keydown', (e) => {
          const currentIndex = panelData.findIndex((p) => p.value === activeValue);
          let newIndex = currentIndex;

          if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault();
            newIndex = (currentIndex + 1) % panelData.length;
          } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault();
            newIndex = (currentIndex - 1 + panelData.length) % panelData.length;
          } else if (e.key === 'Home') {
            e.preventDefault();
            newIndex = 0;
          } else if (e.key === 'End') {
            e.preventDefault();
            newIndex = panelData.length - 1;
          }

          if (newIndex !== currentIndex) {
            const newValue = panelData[newIndex].value;
            const newTab = tabsContainer.querySelector(
              `[data-panel-value="${newValue}"]`
            ) as HTMLButtonElement | null;
            newTab?.click();
            newTab?.focus();
          }
        });

        tabsContainer.appendChild(button);
      });

      // Initialize panel visibility
      panelData.forEach(({ value, element }) => {
        element.setAttribute('id', `panel-${value}`);
        element.setAttribute('role', 'tabpanel');
        element.setAttribute('aria-labelledby', `tab-${value}`);

        if (value === activeValue) {
          element.classList.remove('hidden');
          element.setAttribute('aria-hidden', 'false');
        } else {
          element.classList.add('hidden');
          element.setAttribute('aria-hidden', 'true');
        }
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPanelSwitcher);
  } else {
    initPanelSwitcher();
  }

  // Re-initialize on navigation (Astro View Transitions)
  document.addEventListener('astro:page-load', initPanelSwitcher);
</script>

<style>
  .panel-switcher-wrapper {
    margin: 1.5rem 0;
  }

  .panel-switcher-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border);
    border-radius: 0.75rem;
    flex-wrap: wrap;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .panel-switcher-tab {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border);
    border-radius: 0.5rem;
    color: var(--fg-secondary);
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Inconsolata', monospace;
    outline: none;
  }

  .panel-switcher-tab:hover {
    background: var(--bg-tertiary);
    color: var(--fg-secondary);
    border-color: var(--border);
  }

  .panel-switcher-tab:focus-visible {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
  }

  .panel-switcher-tab.active {
    background: var(--accent-blue);
    color: #ffffff;
    border-color: var(--accent-blue);
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(122, 162, 247, 0.3);
    transform: translateY(-1px);
  }

  .panel-switcher-content {
    position: relative;
    min-height: 2rem;
  }

  .panel-switcher-content > [data-panel-label] {
    display: block;
    animation: fadeIn 0.2s ease-in-out;
  }

  .panel-switcher-content > [data-panel-label].hidden {
    display: none !important;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .panel-switcher-tabs {
      gap: 0.375rem;
      padding: 0.375rem;
    }

    .panel-switcher-tab {
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
    }
  }
</style>

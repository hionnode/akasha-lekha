---
interface Props {
  mode?: 'unified' | 'split';
  class?: string;
}

const { mode = 'unified', class: className = '' } = Astro.props;
---

<div
  class={`diff-viewer diff-viewer-${mode} ${className}`}
  role="region"
  aria-label={`Code diff viewer (${mode} mode)`}
>
  <slot />
</div>

<script>
  function initDiffViewer() {
    const viewers = document.querySelectorAll('.diff-viewer');

    viewers.forEach((viewer) => {
      const blocks = viewer.querySelectorAll('[data-diff-type]');

      blocks.forEach((block) => {
        const type = block.getAttribute('data-diff-type');
        if (type === 'added' || type === 'removed') {
          block.classList.add(`diff-${type}`);
        }
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDiffViewer);
  } else {
    initDiffViewer();
  }

  // Re-initialize on navigation (Astro View Transitions)
  document.addEventListener('astro:page-load', initDiffViewer);
</script>

<style>
  .diff-viewer {
    margin: 1.5rem 0;
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .diff-viewer-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
  }

  .diff-viewer-unified [data-diff-type] {
    position: relative;
    padding-left: 3rem;
  }

  .diff-viewer-unified [data-diff-type='added']::before {
    content: '+';
    position: absolute;
    left: 0;
    width: 2rem;
    text-align: center;
    font-weight: bold;
    color: var(--accent-green);
  }

  .diff-viewer-unified [data-diff-type='removed']::before {
    content: '-';
    position: absolute;
    left: 0;
    width: 2rem;
    text-align: center;
    font-weight: bold;
    color: var(--accent-red);
  }

  .diff-added {
    background: rgba(158, 206, 106, 0.1);
    border-left: 3px solid var(--accent-green);
  }

  .diff-removed {
    background: rgba(247, 118, 142, 0.1);
    border-left: 3px solid var(--accent-red);
  }

  .diff-viewer-split .diff-added {
    border-right: 1px solid var(--border);
  }

  .diff-viewer-split .diff-removed {
    border-left: 1px solid var(--border);
  }

  .diff-viewer pre {
    margin: 0;
    padding: 1rem;
    background: transparent;
    border: none;
  }

  .diff-viewer code {
    background: transparent;
  }
</style>

---
import { getCollection } from 'astro:content';

// Get all unique tags from guides
const allGuides = await getCollection('guides');
const guideIndexes = allGuides.filter((guide) => 'parts' in guide.data);

const allTags = Array.from(
  new Set(guideIndexes.flatMap((guide) => (guide.data as { tags: string[] }).tags || []))
).sort();

const tagCounts: Record<string, number> = {};
guideIndexes.forEach((guide) => {
  (guide.data as { tags: string[] }).tags?.forEach((tag) => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
});
---

<div class="mb-6 p-6 bg-bg-secondary border border-border rounded-lg">
  <!-- Search Bar -->
  <div class="mb-6">
    <label for="guide-search" class="block text-sm font-semibold text-fg-secondary mb-2">
      Search
    </label>
    <input
      type="text"
      id="guide-search"
      placeholder="Search guides by title or description..."
      class="w-full px-4 py-2 bg-bg-primary border border-border rounded focus:outline-none focus:ring-2 focus:ring-accent-blue focus:border-accent-blue text-fg-primary font-mono text-sm"
    />
  </div>

  <!-- Tag Filter -->
  <div>
    <label class="block text-sm font-semibold text-fg-secondary mb-3">
      Filter by Tags
    </label>
    <div id="guide-tag-filter-container" class="flex flex-wrap gap-2">
      {allTags.map((tag) => (
        <button
          data-tag={tag}
          class="guide-tag-filter-btn px-3 py-1.5 text-xs font-semibold uppercase tracking-wider border border-border bg-bg-primary text-fg-muted hover:bg-bg-tertiary hover:text-accent-blue hover:border-accent-blue transition-colors rounded"
        >
          {tag}
          <span class="ml-2 text-fg-muted">({tagCounts[tag]})</span>
        </button>
      ))}
    </div>
    <div id="guide-active-filters" class="mt-4 flex flex-wrap gap-2 items-center">
      <span class="text-xs text-fg-muted">Active filters:</span>
      <div id="guide-active-filters-list" class="flex flex-wrap gap-2">
        <!-- Active filters will be populated here -->
      </div>
      <button
        id="guide-clear-filters"
        class="text-xs text-accent-blue hover:text-accent-cyan transition-colors hidden"
      >
        Clear all
      </button>
    </div>
  </div>

  <!-- Results Count -->
  <div id="guide-results-count" class="mt-4 text-sm text-fg-muted">
    Showing all guides
  </div>
</div>

<script>
  const searchInput = document.getElementById('guide-search') as HTMLInputElement | null;
  const tagButtons = document.querySelectorAll('.guide-tag-filter-btn');
  const activeFiltersList = document.getElementById('guide-active-filters-list');
  const clearFiltersBtn = document.getElementById('guide-clear-filters');
  const resultsCount = document.getElementById('guide-results-count');
  const emptyState = document.getElementById('guide-empty-state');

  let activeTags = new Set<string>();
  let searchQuery = '';
  interface GuideData {
    element: HTMLElement;
    title: string;
    description: string;
    tags: string[];
    partCount: number;
    readTime: number;
  }
  let guidesData: GuideData[] = [];

  function updateActiveFiltersDisplay() {
    if (!activeFiltersList || !clearFiltersBtn) return;

    activeFiltersList.innerHTML = '';
    
    const hasFilters = activeTags.size > 0 || searchQuery.trim().length > 0;
    
    if (!hasFilters) {
      clearFiltersBtn.classList.add('hidden');
      return;
    }

    clearFiltersBtn.classList.remove('hidden');

    // Show search query as a badge if present
    if (searchQuery.trim().length > 0) {
      const searchEl = document.createElement('button');
      searchEl.className =
        'px-2 py-1 text-xs font-semibold uppercase tracking-wider border border-accent-blue bg-accent-blue/20 text-accent-blue hover:bg-accent-blue/30 transition-colors rounded flex items-center gap-1';
      searchEl.innerHTML = `
        Search: "${searchQuery}"
        <span class="text-accent-blue">×</span>
      `;
      searchEl.addEventListener('click', () => {
        searchQuery = '';
        if (searchInput) (searchInput as HTMLInputElement).value = '';
        updateActiveFiltersDisplay();
        filterAndSort();
      });
      activeFiltersList.appendChild(searchEl);
    }

    // Show tag filters
    activeTags.forEach((tag) => {
      const tagEl = document.createElement('button');
      tagEl.className =
        'px-2 py-1 text-xs font-semibold uppercase tracking-wider border border-accent-blue bg-accent-blue/20 text-accent-blue hover:bg-accent-blue/30 transition-colors rounded flex items-center gap-1';
      tagEl.innerHTML = `
        ${tag}
        <span class="text-accent-blue">×</span>
      `;
      tagEl.addEventListener('click', () => {
        activeTags.delete(tag);
        updateTagButtons();
        updateActiveFiltersDisplay();
        filterAndSort();
      });
      activeFiltersList.appendChild(tagEl);
    });
  }

  function updateTagButtons() {
    tagButtons.forEach((btn) => {
      const tag = (btn as HTMLElement).dataset.tag;
      if (tag && activeTags.has(tag)) {
        btn.classList.add('bg-accent-blue/20', 'border-accent-blue', 'text-accent-blue');
        btn.classList.remove('bg-bg-primary', 'text-fg-muted');
      } else {
        btn.classList.remove('bg-accent-blue/20', 'border-accent-blue', 'text-accent-blue');
        btn.classList.add('bg-bg-primary', 'text-fg-muted');
      }
    });
  }

  function filterAndSort() {
    const query = searchQuery.toLowerCase().trim();
    let filtered = guidesData.filter((guide) => {
      // Search filter
      if (query) {
        const matchesSearch =
          guide.title.toLowerCase().includes(query) ||
          guide.description.toLowerCase().includes(query) ||
          guide.tags.some((tag: string) => tag.toLowerCase().includes(query));
        if (!matchesSearch) return false;
      }

      // Tag filter (AND logic - must have all selected tags)
      if (activeTags.size > 0) {
        const hasAllTags = Array.from(activeTags).every((selectedTag: string) =>
          guide.tags.some((tag: string) => tag.toLowerCase() === selectedTag.toLowerCase())
        );
        if (!hasAllTags) return false;
      }

      return true;
    });

    // Get the container
    const container = document.getElementById('guide-list-container');
    if (!container) return;

    // Hide all guides
    guidesData.forEach((guide) => {
      guide.element.style.display = 'none';
    });

    // Show filtered guides
    filtered.forEach((guide) => {
      guide.element.style.display = '';
      container.appendChild(guide.element);
    });

    // Update results count
    if (resultsCount) {
      const total = guidesData.length;
      const showing = filtered.length;
      if (showing === total) {
        resultsCount.textContent = `Showing all ${total} guides`;
      } else {
        resultsCount.textContent = `Showing ${showing} of ${total} guides`;
      }
    }

    // Show/hide empty state
    if (emptyState) {
      const hasGuides = guidesData.length > 0;
      const hasFilteredResults = filtered.length > 0;
      const hasActiveFilters = activeTags.size > 0 || searchQuery.trim().length > 0;
      
      if (hasGuides && hasActiveFilters && !hasFilteredResults) {
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
      }
    }
  }

  // Search input with debouncing
  let searchTimeout: ReturnType<typeof setTimeout> | null = null;
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const value = (e.target as HTMLInputElement).value;
      
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      searchTimeout = setTimeout(() => {
        searchQuery = value;
        updateActiveFiltersDisplay();
        filterAndSort();
      }, 300);
    });
  }

  // Tag buttons
  tagButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const tag = (btn as HTMLElement).dataset.tag;
      if (tag) {
        if (activeTags.has(tag)) {
          activeTags.delete(tag);
        } else {
          activeTags.add(tag);
        }
        updateTagButtons();
        updateActiveFiltersDisplay();
        filterAndSort();
      }
    });
  });

  // Clear filters
  function clearAllFilters() {
    activeTags.clear();
    searchQuery = '';
    if (searchInput) (searchInput as HTMLInputElement).value = '';
    if (searchTimeout) {
      clearTimeout(searchTimeout);
      searchTimeout = null;
    }
    updateTagButtons();
    updateActiveFiltersDisplay();
    filterAndSort();
  }

  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', clearAllFilters);
  }

  const clearFiltersEmptyBtn = document.getElementById('guide-clear-filters-empty');
  if (clearFiltersEmptyBtn) {
    clearFiltersEmptyBtn.addEventListener('click', clearAllFilters);
  }

  // Initialize
  function initialize() {
    const guideCards = document.querySelectorAll('#guide-list-container > [data-guide-card]');
    guidesData = [];
    
    guideCards.forEach((card) => {
      const element = card as HTMLElement;
      if (element.dataset.title && element.dataset.tags) {
        guidesData.push({
          element,
          title: element.dataset.title || '',
          description: element.dataset.description || '',
          tags: JSON.parse(element.dataset.tags || '[]'),
          partCount: parseInt(element.dataset.partCount || '0'),
          readTime: parseInt(element.dataset.readTime || '0'),
        });
      }
    });
    
    updateTagButtons();
    updateActiveFiltersDisplay();
    filterAndSort();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initialize, 200);
    });
  } else {
    setTimeout(initialize, 200);
  }

  document.addEventListener('astro:page-load', () => {
    setTimeout(initialize, 200);
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Only handle shortcuts when not typing in an input/textarea
    const target = e.target as HTMLElement;
    if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable) {
      return;
    }

    // `/` key focuses search input
    if (e.key === '/' && searchInput) {
      e.preventDefault();
      searchInput.focus();
    }

    // `Esc` key clears filters
    if (e.key === 'Escape') {
      clearAllFilters();
    }
  });
</script>


---
interface Props {
  data?: string;
}

const { data } = Astro.props;
---

<div
  id="tag-filter-overlay"
  class="hidden fixed inset-0 bg-bg-primary/95 z-50 flex items-center justify-center"
>
  <div class="w-full max-w-3xl px-8">
    <div class="mb-4 text-fg-secondary">
      <span class="text-accent-cyan">t</span> Filter by Tags
    </div>
    <div
      id="tag-filter-list"
      class="bg-bg-secondary border-2 border-border rounded p-4 max-h-96 overflow-y-auto"
    >
      <!-- Tags will be populated by script -->
    </div>
    <div class="mt-4 flex items-center justify-between">
      <div class="text-sm text-fg-muted">
        Press <kbd class="px-2 py-1 bg-bg-tertiary border border-border rounded">Esc</kbd> to close,
        <kbd class="px-2 py-1 bg-bg-tertiary border border-border rounded">Enter</kbd> to apply
      </div>
      <div id="selected-tags-count" class="text-sm text-accent-blue">0 tags selected</div>
    </div>
  </div>
</div>

<script>
  const tagFilterOverlay = document.getElementById('tag-filter-overlay');
  const tagFilterList = document.getElementById('tag-filter-list');
  const selectedTagsCount = document.getElementById('selected-tags-count');
  const selectedTags = new Set<string>();
  let tagData: Array<[string, number]> = [];

  // Initialize tag data from props
  const dataStr = document.currentScript?.getAttribute('data-tag-data');
  if (dataStr) {
    try {
      const data = JSON.parse(dataStr);
      tagData = Object.entries(data.allTags || {}).sort(
        (a, b) => (b[1] as number) - (a[1] as number)
      ) as Array<[string, number]>;
    } catch (e) {
      console.error('Failed to parse tag data', e);
    }
  }

  function showTagFilter() {
    if (tagFilterOverlay) {
      tagFilterOverlay.classList.remove('hidden');
      renderTags();
    }
  }

  function hideTagFilter() {
    if (tagFilterOverlay) {
      tagFilterOverlay.classList.add('hidden');
    }
  }

  function applyTagFilter() {
    window.dispatchEvent(
      new CustomEvent('tags-apply', {
        detail: { tags: Array.from(selectedTags) },
      })
    );
    hideTagFilter();
  }

  function renderTags() {
    if (!tagFilterList) return;

    // Use tagData or fallback to window.tuiTagData
    const tags = tagData.length > 0 ? tagData : (window as any).tuiTagData || [];

    tagFilterList.innerHTML = tags
      .map(([tag, count]: [string, number]) => {
        const isSelected = selectedTags.has(tag);
        return `
          <button
            data-tag="${tag}"
            class="tag-filter-btn w-full text-left px-3 py-2 rounded mb-2 hover:bg-bg-tertiary transition-colors focus:outline-none focus:ring-2 focus:ring-accent-blue flex items-center justify-between ${
              isSelected
                ? 'bg-accent-blue/20 border border-accent-blue'
                : 'border border-transparent'
            }"
          >
            <span class="text-sm">${tag}</span>
            <span class="text-xs text-fg-muted">${count}</span>
          </button>
        `;
      })
      .join('');

    // Add click handlers
    tagFilterList.querySelectorAll('.tag-filter-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const tag = (btn as HTMLElement).dataset.tag;
        if (tag) {
          if (selectedTags.has(tag)) {
            selectedTags.delete(tag);
          } else {
            selectedTags.add(tag);
          }
          renderTags();
          if (selectedTagsCount) {
            selectedTagsCount.textContent = `${selectedTags.size} tag${selectedTags.size !== 1 ? 's' : ''} selected`;
          }
        }
      });
    });
  }

  // Listen for tag filter activation
  window.addEventListener('tag-filter-activate', showTagFilter);

  // Handle keyboard
  document.addEventListener('keydown', (e) => {
    if (!tagFilterOverlay?.classList.contains('hidden')) {
      if (e.key === 'Escape') {
        e.preventDefault();
        hideTagFilter();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        applyTagFilter();
      }
    }
  });

  // Listen for tag data updates
  window.addEventListener('tag-data-update', ((e: CustomEvent) => {
    (window as any).tuiTagData = e.detail.tags;
    tagData = e.detail.tags;
    if (!tagFilterOverlay?.classList.contains('hidden')) {
      renderTags();
    }
  }) as EventListener);
</script>

<script data-tag-data={data} is:inline>
  // Tag data passed via data attribute
</script>

<style>
  .tag-filter-btn {
    font-family: 'Inconsolata', monospace;
  }
</style>
